<!DOCTYPE html>

<head>
	<meta charset="utf-8" />
	<title>Домашно 8: Пилето</title>

	<script src="webgl-fmi.js"></script>
	<script src="skeleton.js"></script>
	<script src="framebuffer.js"></script>

	<script>
		var shadowFrameBuffer, shadowTexture, shadowDepthTexture, shadowWidth = 1024, shadowHeight = 1024;
		var width, height;
		var cameraProj, shadowProj;
		var lightDir = [0, -1 , 1];

		function start() {
			var canvas = document.getElementById("picasso");
			canvas.addEventListener('webglcontextlost', function (event) { event.preventDefault(); }, false);
			canvas.addEventListener('webglcontextrestored', function () { init(); }, false);

			prepareInit();
		}

		function prepareInit() {
			vShader = null;
			fShader = null;
			loadFile("shader.vs", (text) => {
				vShader = text;
				init();
			});
			loadFile("shader.fs", (text) => {
				fShader = text;
				init();
			});
			vDepthShader = null;
			fDepthShader = null;
			loadFile("depth.vs", (text) => {
				vDepthShader = text;
				init();
			});
			loadFile("depth.fs", (text) => {
				fDepthShader = text;
				init();
			});
			vScreenShader = null;
			fScreenShader = null;
			loadFile("screen.vs", (text) => {
				vScreenShader = text;
				init();
			});
			loadFile("screen.fs", (text) => {
				fScreenShader = text;
				init();
			});
		}

		function isReadyForInit() {
			if (!vShader) return false;
			if (!fShader) return false;
			if (!vDepthShader) return false;
			if (!fDepthShader) return false;
			if (!vScreenShader) return false;
			if (!fScreenShader) return false;
			return true;
		}

		function init() {
			if (!isReadyForInit()) return;

			gl = getContext("picasso");

			mainProg = getProgram(vShader, fShader);
			depthProg = getProgram(vDepthShader, fDepthShader);
			screenProg = getProgram(vScreenShader, fScreenShader);
			
			getVariables(mainProg);
			getVariables(depthProg);
			getVariables(screenProg);
			
			gl.enable(gl.DEPTH_TEST);
			gl.clearColor(1, 1, 1, 1);
			
			activateProgram(mainProg);
			identity();
			perspective(30, gl.canvas.width / gl.canvas.height, 1, 100);
			cameraProj = glpmat;
			shadowProj = orthoMatrix(30, 30, 1, 100);

			gl.uniform1i(mainProg.uUseNormalMatrix, false);
			gl.uniform3f(mainProg.uDiffuseColor, 1.0, 1.0, 1.0);
			gl.uniform3f(mainProg.uLightDir, lightDir[0], lightDir[1], lightDir[2]);

			width = gl.canvas.width;
			height = gl.canvas.height;
			
			shadowDepthTexture = makeDepthTexture(shadowWidth, shadowHeight);
			shadowTexture = makeColorTexture(shadowWidth, shadowHeight);
			shadowFrameBuffer = makeFrameBuffer(shadowWidth, shadowHeight, [
				[gl.COLOR_ATTACHMENT0, shadowTexture],
				[gl.DEPTH_ATTACHMENT, shadowDepthTexture]
			]);

			screenQuad = new ScreenQuad();

			setupInput()

			robot = new Robot();

			bird = new Bird();
			bird.base = [2,2,2];

			yaw = 0;
			pitch = Math.PI / 4;

			drawFrame();
		}

		function now() { return (new Date()).getTime() / 1000; }

		function placeCamera() {
			yaw = -robot.yaw / 180 * Math.PI;
			pitch = (90 + robot.pitch) / 180 * Math.PI;
			if (pitch > Math.PI) pitch = Math.PI;
			if (pitch < 0) pitch = 0.0001;
			lookAt([
				30 * cos(yaw) * sin(pitch) + robot.pos[0],
				30 * sin(yaw) * sin(pitch) + robot.pos[1],
				30 * cos(pitch) + robot.pos[2] + 3
			], [
				robot.pos[0],
				robot.pos[1],
				robot.pos[2] + 3
			], [0, 0, 1]);
		}

		function update() {
			var time = now();

			gl.clear(gl.COLOR_BUFFER_BIT + gl.DEPTH_BUFFER_BIT);

			var a = time / 3;

			bird.animate(time);

			gl.bindTexture(gl.TEXTURE_2D, shadowTexture);
			heightPass();
			gl.bindFramebuffer(gl.FRAMEBUFFER, shadowFrameBuffer);
			const pixels = new Uint8Array(4);
			gl.readPixels(
				Math.floor(shadowWidth / 2), 
				Math.floor(shadowHeight / 2),
				1, 1, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
			// console.log(pixels[0]);
			robot.pos[2] = 40 - pixels[0] / 255 * 100;
			gl.bindFramebuffer(gl.FRAMEBUFFER, null);

			moveRobot();
			mouseDelta = [0, 0];

			drawFrame();
		}

		function drawFrame() {
			// gl.viewport(0, 0, width, height);
			// activateProgram(screenProg);
			// gl.bindTexture(gl.TEXTURE_2D, shadowTexture);
			// screenQuad.draw();

			shadowPass();
			gl.bindTexture(gl.TEXTURE_2D, shadowDepthTexture);


			gl.viewport(0, 0, width, height);
			activateProgram(mainProg);
			
			var shadowMat = multiplyMatrix(glpmat, glvmat);
			gl.uniformMatrix4fv(mainProg.uShadowMatrix,false,shadowMat);

			setProjMatrix(cameraProj);
			placeCamera();
			drawScene();

			// activateProgram(screenProg);
			// gl.bindTexture(gl.TEXTURE_2D, shadowDepthTexture);
			// screenQuad.draw();

			activateProgram(mainProg);
			requestAnimationFrame(update);
		}

		function drawTerrain() {
			for (c of floor) c.draw();
		}

		function drawScene() {
			drawTerrain();
			robot.draw(time);
			bird.draw();
		}

		function shadowPass() {
			gl.bindFramebuffer(gl.FRAMEBUFFER, shadowFrameBuffer);
			gl.viewport(0, 0, shadowWidth, shadowHeight);
			gl.clearColor(1, 1, 1, 1);
			gl.clear(gl.COLOR_BUFFER_BIT + gl.DEPTH_BUFFER_BIT);

			activateProgram(depthProg);

			lookAt([
				robot.pos[0] + lightDir[0] * 40, 
				robot.pos[1] + lightDir[1] * 40, 
				robot.pos[2] + lightDir[2] * 40
			], robot.pos, [0,0,1]);
			setProjMatrix(shadowProj);

			drawScene();
			gl.bindFramebuffer(gl.FRAMEBUFFER, null);
		}

		function heightPass() {
			gl.bindFramebuffer(gl.FRAMEBUFFER, shadowFrameBuffer);
			gl.viewport(0, 0, shadowWidth, shadowHeight);
			gl.clearColor(1, 1, 1, 1);
			gl.clear(gl.COLOR_BUFFER_BIT + gl.DEPTH_BUFFER_BIT);

			activateProgram(depthProg);

			lookAt([
				robot.pos[0], 
				robot.pos[1], 
				40], 
				robot.pos, [0,1,0]);
			setProjMatrix(shadowProj);

			drawTerrain();
			gl.bindFramebuffer(gl.FRAMEBUFFER, null);
		}

		function setupInput() {
			isKeyPressed = [];
			document.addEventListener("keydown", (e) => {
				isKeyPressed[e.key] = true;
			});

			document.addEventListener("keyup", (e) => {
				isKeyPressed[e.key] = false;
			});

			mousePos = [0, 0];
			mouseDelta = [0, 0];
			picasso.addEventListener("mousemove", (e) => {
				mousePos = [e.x, e.y];
				mouseDelta = [e.movementX, e.movementY];
			});

			floor = [];
			for (let i = 0; i < 10; ++i) {
				for (let j = 0; j < 10; ++j) {
					floor.push(custom(
						new Cuboid([i * 5 - 25, j * 5 - 25, -0.5 + 2 * (Math.random() - 0.5)], [5, 5, 1]),
						{
							color: [Math.random(), Math.random(), Math.random()]
						}));
				}
			}

			isPointerLocked = false;
			let canvas = document.getElementById('picasso');
			canvas.addEventListener('click', lockCursor);
			document.addEventListener('pointerlockchange', () => isPointerLocked = !isPointerLocked);
		}

		function moveRobot() {
			let speed = 0.03;

			if (isKeyPressed['ArrowLeft']) {
				robot.yaw -= 10. * speed;
			}
			if (isKeyPressed['ArrowRight']) {
				robot.yaw += 10. * speed;
			}
			if (isPointerLocked) {
				robot.yaw += mouseDelta[0] * 0.2;
				robot.pitch += -mouseDelta[1];
			}

			let r = -robot.yaw / 180 * Math.PI;
			let forward = [
				cos(r) * speed, sin(r) * speed
			];
			let sideways = [
				-sin(r) * speed, cos(r) * speed
			];

			if (isKeyPressed['w']) {
				robot.pos[0] -= forward[0];
				robot.pos[1] -= forward[1];
			}
			if (isKeyPressed['s']) {
				robot.pos[0] += forward[0];
				robot.pos[1] += forward[1];
			}
			if (isKeyPressed['a']) {
				robot.pos[0] -= sideways[0];
				robot.pos[1] -= sideways[1];
			}
			if (isKeyPressed['d']) {
				robot.pos[0] += sideways[0];
				robot.pos[1] += sideways[1];
			}
		}

		function lockCursor() {
			if (isPointerLocked) {
				document.exitPointerLock();
			} else {
				document.getElementById('picasso').requestPointerLock();
			}
		}
	</script>
</head>

<body onload="start()">
	<h2>Домашно 8: Пилето</h2>

	<noscript>
		Искаме JavaScript, но няма!
	</noscript>

	<canvas id="picasso" width="1000" height="800" style="border: solid;">
		Искаме canvas, но няма!
	</canvas>
</body>